<!DOCTYPE html>
<html>
<head>
    <title>Authenticating...</title>
    <script src="https://res.cdn.office.net/teams-js/2.12.0/js/MicrosoftTeams.min.js" xintegrity="sha384-yBd3y324qJ23hCjB8x2G4U+6eD/41hFvI9e4f3NA0vEy3S14kLclTFlbFFm2iIe" crossorigin="anonymous"></script>
    <script src="https://alcdn.msauth.net/browser/2.38.0/js/msal-browser.min.js"></script>
</head>
<body>
    <script type="text/javascript">
        // ====================================================================================
        // IMPORTANT PRODUCTION NOTE:
        // This is a static HTML file and cannot read from your .env file.
        // If you change your Azure App Registration (clientId) or your Tenant ID,
        // YOU MUST MANUALLY UPDATE THE VALUES BELOW to match your new configuration.
        // Failure to do so will break the authentication flow.
        // ====================================================================================
        const clientId = "ad2de1bb-a645-4140-996c-45a61436c5ba";
        const tenantId = "0db7b087-e47f-44cd-85e3-ce0bd7cb19c7"; 

        (async () => {
            try {
                await microsoftTeams.app.initialize();

                const msalConfig = {
                    auth: {
                        clientId: clientId,
                        authority: `https://login.microsoftonline.com/${tenantId}`,
                        redirectUri: window.location.origin + "/auth.html"
                    },
                    cache: {
                        cacheLocation: "sessionStorage",
                        storeAuthStateInCookie: false,
                    }
                };

                const msalInstance = new msal.PublicClientApplication(msalConfig);
                await msalInstance.initialize();

                const response = await msalInstance.handleRedirectPromise();

                if (response && response.idToken) {
                    microsoftTeams.authentication.notifySuccess(response.idToken);
                } else {
                    // Get the login hint from the URL query parameters
                    const urlParams = new URLSearchParams(window.location.search);
                    const loginHint = urlParams.get('loginHint');

                    const loginRequest = {
                        scopes: ["openid", "profile", "email"],
                        loginHint: loginHint || undefined // Pass the hint to MSAL
                    };
                    msalInstance.loginRedirect(loginRequest);
                }
            } catch (error) {
                console.error("Authentication error in popup:", error);
                microsoftTeams.authentication.notifyFailure(error.toString());
            }
        })();
    </script>
</body>
</html>

